{% extends "base.html" %}
{% block title %}AugmentedQuill — Prototype{% endblock %}
{% block content %}
  <div class="aq-shell" data-component="shell-view">
    <aside class="aq-sidebar">
      <div class="aq-sidebar-top">
        <h3 class="aq-sidebar-title">Chapters</h3>
        <ul class="aq-chapters" data-chapter-list>
          <li class="aq-empty">No chapters configured</li>
        </ul>
        <div style="padding: 0.5rem 0.5rem 0;">
          <button class="aq-btn" style="width:100%;" data-action="create-chapter">+ New chapter</button>
        </div>
      </div>
      <div class="aq-sidebar-bottom">
        <!-- Settings moved to header modal opener; duplicate removed -->
      </div>
    </aside>

    <section id="main" class="aq-mainpane">
      <div class="aq-panel">
        <div class="aq-content">
          <div class="aq-card">
            <div data-view="empty">
              <div class="aq-empty">Select a chapter to view its content.</div>
            </div>
            <div data-view="chapter" style="display:none;">
              <div style="font-weight:600; margin-bottom:0.5rem;">Chapter <span data-active-id></span></div>
              <!-- Scoped editor toolbar -->
              <div class="aq-editor-toolbar aq-toolbar" style="gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem; align-items:center;">
                <div role="tablist" aria-label="Editor mode" class="aq-toolbar" style="gap:0.25rem;">
                  <button role="tab" class="aq-seg" data-mode="raw" aria-selected="true">Raw</button>
                  <button role="tab" class="aq-seg" data-mode="markdown" aria-selected="false">Markdown</button>
                  <button role="tab" class="aq-seg" data-mode="wysiwyg" aria-selected="false">WYSIWYG</button>
                </div>
                <div class="aq-flex-spacer" style="flex:1 1 auto;"></div>
                <div class="aq-size-controls aq-toolbar" style="gap:0.25rem;">
                  <button class="aq-btn" data-action="change-width" data-direction="decrease" aria-label="Narrower">− Width</button>
                  <button class="aq-btn" data-action="change-width" data-direction="increase" aria-label="Wider">+ Width</button>
                  <button class="aq-btn" data-action="change-font-size" data-direction="decrease" aria-label="Smaller">A−</button>
                  <button class="aq-btn" data-action="change-font-size" data-direction="increase" aria-label="Bigger">A+</button>
                </div>
                <!-- LLM Story controls (visible in all modes) -->
                <div class="aq-llm-group aq-toolbar" style="gap:0.35rem; margin-left: auto;">
                  <label style="display:inline-flex; align-items:center; gap:0.35rem;">
                    <span style="font-size:0.85rem; color:var(--muted);">Story model</span>
                    <select data-ref="storyModelSelect" class="aq-select aq-select-sm"></select>
                  </label>
                  <button class="aq-btn aq-btn-sm" data-action="story-write-summary" title="Write or update summary"><i class="fas fa-edit"></i> Summary</button>
                  <button class="aq-btn aq-btn-sm" data-action="story-write-chapter" title="Write chapter from summary"><i class="fas fa-file-alt"></i> Write</button>
                  <button class="aq-btn aq-btn-sm" data-action="story-continue-chapter" title="Continue chapter to match summary"><i class="fas fa-forward"></i> Continue</button>
                  <button class="aq-btn aq-btn-sm" data-action="story-cancel" title="Cancel running LLM action" style="display:none;">■ Stop</button>
                </div>
              </div>
              <div data-raw-toolbar class="aq-toolbar" style="gap:0.25rem; flex-wrap:wrap; margin-bottom:0.5rem;">
                <button class="aq-btn aq-btn-sm" title="Bold" data-action="wrap-selection" data-before="**" data-after="**"><strong>B</strong></button>
                <button class="aq-btn aq-btn-sm" title="Italic" data-action="wrap-selection" data-before="*" data-after="*"><em>I</em></button>
                <button class="aq-btn aq-btn-sm" title="Heading" data-action="insert-heading">H1</button>
                <button class="aq-btn aq-btn-sm" title="Link" data-action="insert-link">Link</button>
                <button class="aq-btn aq-btn-sm" title="Code" data-action="wrap-selection" data-before="`" data-after="`">Code</button>
                <button class="aq-btn aq-btn-sm" title="Bullet list" data-action="toggle-list" data-prefix="- ">• List</button>
                <button class="aq-btn aq-btn-sm" title="Quote" data-action="toggle-prefix" data-prefix="> ">❝ Quote</button>
              </div>
              <textarea data-ref="rawEditor"></textarea>
            </div>
          </div>
          <!-- Flow writing mode: simple, low-distraction, two-choice sentence generator -->
          <div class="aq-card" data-component="flow-mode" style="margin-top:0.5rem;">
            <div class="aq-toolbar" style="align-items:center; gap:0.5rem; flex-wrap:wrap;">
              <strong style="font-size:0.95rem;">Flow mode</strong>
              <span class="aq-tip" style="margin:0;">Pick between two one-sentence suggestions to continue the chapter.</span>
              <div class="aq-flex-spacer" style="flex:1 1 auto;"></div>
              <button class="aq-btn aq-btn-sm" data-action="flow-start">Start</button>
              <button class="aq-btn aq-btn-sm" data-action="flow-stop" style="display:none;">Stop</button>
            </div>
            <div data-ref="flowArea" style="display:none; margin-top:0.5rem;">
              <div class="aq-toolbar" style="gap:0.5rem; justify-content:center;">
                <button class="aq-btn" data-action="flow-pick-left" title="Pick left (←)">← Pick</button>
                <button class="aq-btn" data-action="flow-discard" title="Discard both (↓)">↓ New</button>
                <button class="aq-btn" data-action="flow-pick-right" title="Pick right (→)">Pick →</button>
              </div>
              <div class="aq-flow-choices" style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                <div class="aq-flow-choice" data-ref="flowLeft" tabindex="0" style="flex:1; padding:0.5rem; border:1px solid var(--border); border-radius:8px; min-height:3.25rem; background:var(--card);"></div>
                <div class="aq-flow-choice" data-ref="flowRight" tabindex="0" style="flex:1; padding:0.5rem; border:1px solid var(--border); border-radius:8px; min-height:3.25rem; background:var(--card);"></div>
              </div>
              <div class="aq-tip" data-ref="flowHint" style="text-align:center; margin-top:0.5rem;">Use ← or → to choose, ↓ to discard and get new suggestions.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right sidebar: Chat -->
    <aside class="aq-rightbar">
      <div class="aq-rightbar-top" data-component="chat-view">
        <h3 class="aq-sidebar-title">Chat</h3>
        <div class="aq-field" style="margin-top:0.25rem;">
          <label>
            <span style="display:block; font-size:0.85rem; color:var(--muted); margin-bottom:0.25rem;">Model</span>
            <select data-ref="modelSelect"></select>
          </label>
        </div>
        <div class="aq-chat" data-ref="chatList">
          <div class="aq-empty">No messages</div>
        </div>
        <div class="aq-chat-input">
          <div class="aq-field" style="margin:0;">
            <div class="aq-chat-input-row">
              <select class="aq-role-select" data-ref="roleSelect">
                <option value="user" selected>user</option>
                <option value="system">system</option>
                <option value="assistant">assistant</option>
              </select>
              <textarea rows="3" placeholder="Type a message… (Enter to send, Shift+Enter for newline)" data-ref="input"></textarea>
            </div>
          </div>
          <div class="aq-toolbar" style="justify-content: flex-end; margin-top:0.5rem;">
            <button class="aq-btn" data-ref="deleteLast">Delete last</button>
            <button class="aq-btn aq-btn-primary" data-ref="send">Send <span class="aq-spinner" data-ref="sendSpinner" style="display:none;"></span></button>
            <button class="aq-btn" data-ref="regenerate">Regenerate</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
{% endblock %}
